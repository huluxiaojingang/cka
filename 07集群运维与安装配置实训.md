# Instalation,Configuration &Validation 12%

# install master

## Master节点
- etct
- kube-apiserver
- kube-controller-manager
- kube-scheduler
- ...

开始尝试virtualBox Ubuntu虚拟机部署，但是遇到一些奇怪的问题，最终放弃了采用阿里云两台ECS机器。

  
1、install docker
```
apt-get update
apt-get install -y docker.io
```

2、install kubelet kubeadm kubelet
```
关闭swap：vi /etc/fstab 注释掉/swap  重启系统

apt-get update && apt-get install -y apt-transport-https curl
curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
cat <<EOF >/etc/apt/sources.list.d/kubernetes.list
deb https://apt.kubernetes.io/ kubernetes-xenial main
EOF
apt-get update
apt-get install -y kubelet kubeadm kubectl
```

3、kubeadm init
```
# kubeadm init 以Pod形式拉起 master 组件。
kubeadm init --pod-network-cidr=10.244.0.0/16 #pod分配的ip网段

# master 安装成功后需要，执行以下命令
  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

Static Pod
```
kubelet拉起 Static Pod 启动master组件。当kubelet启动时，kubelet --pod-manifest-path=<the directory>，自动创建目录下的所有pod
kubelet 进程 --config参数指定了启动参数，找到staticPodPath字段，
kubelet 会watch配置目录文件的变化，并作出响应。

如何启动Static Pod？ 找到kubelet --pod-manifest-path目录，把自己写的pod yaml文件丢在这个目录下，kubectl会自动创建Static Pod
```




## Node节点
- kubelet
- kube-proxy
- docker
- CNI 插件


同master节点一样安装 kubelet kubeadm kubelet

在master执行，查看kubeadm token
```
kubeadm token list
```

添加node节点命令
```
  kubeadm join 172.24.199.161:6443 --token p0kwhh.kg02s86ge9a0xxk2 --discovery-token-ca-cert-hash  sha256:82d04a08da055d5b8c4da0ebef112c01082081cd10d9ac4e377d187af109b5ec

```
master 节点执行查看node，可以发现已经添加了新的node，但是状态是NotReady
```
kubectl get nodes
```

安装CNI插件，这里用flannel，从官网找地址
```
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/a70459be0084506e4ec919aa1c114638878db11b/Documentation/kube-flannel.yml
```
master节点执行。会创建DaemonSet对象。意味着node也会自动安装。Daemonset安装成功后，集群正常部署完成。  可以执行  kubectl get nodes 显示节点状态是Ready。
kubeconfig相关概念clusters、users、contexts，多集群安全配置参考官网文档
https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/

k8s自动证书签发
kubelet启动时使用底权限token访问kube-apiserver发送证书签发请求csr请求，RBAC配置权限。 kubeadmin join --token  这个token。
kube-controller-manager自动签发证书返回给kube-apiserver。对应的CRS资源对象它的status里会写入证书。
kubelet等待证书签发从CRS资源对象的status里拿到证书，写到node的证书路径下，之后就用新的证书访问apiserver。

RBAC允许的CRS请求类型：

nodeclient：签发证书

selfnodeclient：更新证书

selfnodeserver：更新kubelet server 证书

查看kubelet进程，--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf, --kubeconfig=/etc/kubernetes/kubelet.conf
--bootstrap-kubeconfig 里面的token就是kubeadm join --token =XXX

ps -ef | grep kube-apiserver 查看启动参数中有 -enable-bootstrap-token-auth=true。配置这个参数会自动在kube-system下创建bootstrap-token-xxx的secret，名字为bootstrap-token-XXX，查看这个secret的yaml文件。查看data.auth-extra-groups，base64解码后显示system:bootstrappers:kubeadm:default-node-token。

#### Secret

kubectl get secret bootstrap-token-sm209r -n kube-system -o yaml

```
...
kind: Secret
data:
  auto-extra-groups: (Base64解码后)system:bootstrappers:kubeadm:default-node-token
metadata:
  name: bootstrap-token-sm209r

```


```
kubectl get clusterrole | grep nodeclient
system:certificates.k8s.io:certificatesigningrequests:nodeclient
system:certificates.k8s.io:certificatesigningrequests:selfnodeclient
```

#### ClusterRole  system:certificates.k8s.io:certificatesigningrequests:nodeclient内容
```
kind: ClusterRole
metadata:
  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient
rules:
- apiGroups:
  - vertificates.k8s.io
  resources:
  - certificatesigningrequests/nodeclient
  verbs:
  - create
...

```


kubelet拿到上面的token访问apiserver时，clusterrole配置了verbs:create，resources：certificatesigningrequests/nodeclient，可以调用apiserver

再看下clusterrolebinding   kubeadm:node-autoapprove-bootstrap
kubectl get clusterrolebinding | grep bootstrap


#### ClusterRoleBinding
kubectl get clusterrolebinding  kubeadm:node-autoapprove-bootstrap -o yaml
```
kind: ClusterRoleBinding
...
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:bootstrappers:kubeadm:default-node-token

```















